<div class="mx-auto max-w-screen-xl px-4 sm:px-6 lg:px-8 py-4 sm:py-6">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="flex justify-center items-center py-10">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
    <p class="ml-3 text-lg text-gray-600">Loading comment thread...</p>
  </div>

  <!-- Error Message -->
  <div *ngIf="error && !isLoading"
       class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md shadow-md mb-6" role="alert">
    <p class="font-bold">Error</p>
    <p>{{ error }}</p>
  </div>

  <!-- Main Content -->
  <div *ngIf="commentThread && !isLoading && !error">

    <!-- Discussion Context Panel -->
    <div class="bg-slate-100 dark:bg-slate-800 p-6 rounded-lg shadow-lg mb-8">
      <header class="mb-2">
        <div class="flex items-start space-x-4">
          <img [src]="getAvatarUrl(commentThread.discussionDTO.createBy)" [alt]="commentThread.discussionDTO.createBy + '\'s avatar'"
               class="h-12 w-12 rounded-full object-cover flex-shrink-0">
          <div class="flex-grow">
            <p class="text-sm text-slate-500 dark:text-slate-400">In discussion:</p>
            <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-100">
              <a [routerLink]="['/app/discussions', commentThread.discussionDTO.id, 'view']" class="hover:underline">
                {{ commentThread.discussionDTO.title }}
              </a>
            </h2>
            <p class="text-sm text-slate-600 dark:text-slate-300">
              By
              <a [routerLink]="['/app/users', commentThread.discussionDTO.createBy, 'profile']"
                 class="font-bold hover:underline cursor-pointer">
                {{ commentThread.discussionDTO.createBy }}
              </a>
              on {{ commentThread.discussionDTO.createDate | date:'medium' }}
            </p>
          </div>
        </div>
      </header>
    </div>

    <!-- Comment Timeline -->
    <ol class="relative border-l border-gray-200 dark:border-gray-700 ml-6">
      <li *ngFor="let comment of commentThread.commentDTOs; let last = last" class="mb-10 ml-10">
        <!-- Timeline Icon -->
        <span class="absolute flex items-center justify-center w-12 h-12 bg-blue-100 rounded-full -left-6 ring-8 ring-white dark:ring-gray-900 dark:bg-blue-900">
          <img [src]="getAvatarUrl(comment.createBy)" [alt]="comment.createBy + '\'s avatar'" class="w-12 h-12 rounded-full object-cover">
        </span>

        <!-- Comment Card -->
        <div class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm dark:bg-gray-700 dark:border-gray-600"
             [ngClass]="{'ring-2 ring-indigo-500 dark:ring-indigo-400': last}">
          <div class="items-center justify-between mb-3 sm:flex">
            <div class="text-sm font-normal text-gray-500 dark:text-gray-300">
              <a [routerLink]="['/app/users', comment.createBy, 'profile']" class="font-semibold text-gray-900 dark:text-white hover:underline">{{ comment.createBy }}</a>
              replied on {{ comment.createDate | date:'medium' }}
            </div>
            <div *ngIf="last" class="mt-2 sm:mt-0">
              <span class="bg-indigo-100 text-indigo-800 text-xs font-medium px-2.5 py-0.5 rounded dark:bg-indigo-900 dark:text-indigo-300">
                Current Comment
              </span>
            </div>
          </div>
          <div class="p-3 text-sm font-normal text-gray-500 bg-gray-50 rounded-lg border border-gray-200 dark:bg-gray-600 dark:border-gray-500 dark:text-gray-300">
            <h4 class="text-base font-semibold text-gray-800 dark:text-slate-100 mb-2">{{ comment.title }}</h4>
            <markdown [data]="comment.content" class="toastui-viewer-styling"></markdown>

            <!-- Images & Attachments -->
            <div *ngIf="(comment.images && comment.images.length > 0) || (comment.attachments && comment.attachments.length > 0)"
                 class="mt-4 pt-3 border-t border-gray-200 dark:border-gray-500">
              <button *ngIf="comment.images && comment.images.length > 0" (click)="openGalleria(comment.images)"
                      class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 mr-2">
                <ng-icon name="heroPhoto" class="mr-1.5" size="1em"></ng-icon>
                View Images ({{ comment.images.length }})
              </button>
              <app-file-list [files]="comment.attachments ?? []"></app-file-list>
            </div>
          </div>
        </div>
      </li>
    </ol>

  </div>

  <!-- Galleria Dialog -->
  <p-dialog [(visible)]="galleriaVisible" [modal]="true" [style]="{width: '800px'}" [baseZIndex]="10000"
            [draggable]="false" [resizable]="false" (onHide)="closeGalleria()">
    <p-galleria [value]="currentGalleriaImages" [responsiveOptions]="responsiveOptions" [numVisible]="5"
                [showThumbnails]="true" [showIndicators]="true" [showItemNavigators]="true">
      <ng-template pTemplate="item" let-item>
        <img [src]="item.image" [alt]="item.alt" style="width: 100%; display: block;" />
      </ng-template>
      <ng-template pTemplate="thumbnail" let-item>
        <img [src]="item.thumbnail" [alt]="item.alt" style="width: 100%; display: block;" />
      </ng-template>
      <ng-template pTemplate="caption" let-item>
        <h4 style="margin-bottom: .5em;">{{item.title}}</h4>
      </ng-template>
    </p-galleria>
  </p-dialog>

</div>
