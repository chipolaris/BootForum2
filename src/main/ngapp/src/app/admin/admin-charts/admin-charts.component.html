<div class="mx-auto max-w-screen-xl px-4 sm:px-6 lg:px-8 py-4 sm:py-6">
  <p-toast></p-toast>
  <header class="mb-8">
    <h1 class="text-3xl font-bold text-slate-800 dark:text-slate-100">Forum Analytics</h1>
    <p class="text-slate-600 dark:text-slate-300 mt-1">Visual insights into forum activity.</p>
  </header>

  <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
    <!-- Content Activity Chart -->
    <div class="card bg-white dark:bg-slate-800 p-4 rounded-lg shadow">
      <h2 class="text-lg font-semibold text-slate-800 dark:text-slate-100 mb-4">New Content (Last 12 Months)</h2>
      <div *ngIf="isLoading" class="relative h-96">
        <p-skeleton height="100%"></p-skeleton>
      </div>
      <div *ngIf="!isLoading && contentActivityData" class="relative h-96">
        <p-chart type="bar" [data]="contentActivityData" [options]="contentActivityOptions"></p-chart>
      </div>
    </div>

    <!-- New Users Chart -->
    <div class="card bg-white dark:bg-slate-800 p-4 rounded-lg shadow">
      <h2 class="text-lg font-semibold text-slate-800 dark:text-slate-100 mb-4">New Users (Last 12 Months)</h2>
      <div *ngIf="isLoading" class="relative h-96">
        <p-skeleton height="100%"></p-skeleton>
      </div>
      <div *ngIf="!isLoading && newUsersData" class="relative h-96">
        <p-chart type="bar" [data]="newUsersData" [options]="newUsersOptions"></p-chart>
      </div>
    </div>

    <!-- Forum Activity Chart -->
    <div class="card bg-white dark:bg-slate-800 p-4 rounded-lg shadow xl:col-span-2">
      <h2 class="text-lg font-semibold text-slate-800 dark:text-slate-100 mb-4">Top 10 Forums by Activity</h2>
      <div *ngIf="isLoading" class="relative h-96">
        <p-skeleton height="100%"></p-skeleton>
      </div>
      <div *ngIf="!isLoading && forumActivityData" class="relative h-96">
        <p-chart type="bar" [data]="forumActivityData" [options]="forumActivityOptions"></p-chart>
      </div>
    </div>

    <!-- Top Keywords Chart -->
    <div class="card bg-white dark:bg-slate-800 p-4 rounded-lg shadow xl:col-span-2">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4">
        <h2 class="text-lg font-semibold text-slate-800 dark:text-slate-100">Top Keywords in Discussion's Title and Content</h2>

        <!-- Filter Controls -->
        <div *ngIf="topTermsLoaded" class="flex items-center justify-end gap-4 mt-4 sm:mt-0">
          <!-- Period Dropdown -->
          <div>
            <label for="topTermsPeriod" class="text-sm font-medium text-gray-700 dark:text-gray-300 mr-2">Period:</label>
            <select id="topTermsPeriod" [(ngModel)]="topTermsPeriod" class="rounded-md border-gray-300 shadow-sm dark:bg-slate-700 dark:text-gray-300 dark:border-slate-500 text-sm">
              <option *ngFor="let option of periodOptions" [value]="option.value">{{ option.label }}</option>
            </select>
          </div>
          <!-- Limit Dropdown -->
          <div>
            <label for="topTermsLimit" class="text-sm font-medium text-gray-700 dark:text-gray-300 mr-2">Limit:</label>
            <select id="topTermsLimit" [(ngModel)]="topTermsLimit" class="rounded-md border-gray-300 shadow-sm dark:bg-slate-700 dark:text-gray-300 dark:border-slate-500 text-sm">
              <option *ngFor="let option of limitOptions" [value]="option.value">{{ option.label }}</option>
            </select>
          </div>
          <!-- Refresh Button -->
          <button (click)="loadTopTerms()" [disabled]="isTopTermsLoading"
                  class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-sky-600 hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 disabled:bg-sky-300">
            <span class="pi pi-refresh" [ngClass]="{'animate-spin': isTopTermsLoading}"></span>
            <span class="ml-2">Refresh</span>
          </button>
        </div>
      </div>

      <!-- Initial state with button -->
      <div *ngIf="!topTermsLoaded" class="text-center py-20">
        <button (click)="loadTopTerms()"
                class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-sky-600 hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 cursor-pointer">
          <span class="pi pi-chart-bar mr-2"></span>
          Load Top Keywords Chart
        </button>
        <p class="text-sm text-slate-500 mt-2">This is loaded on-demand to improve initial page performance.</p>
      </div>

      <!-- Loading and Chart display state -->
      <div *ngIf="topTermsLoaded" class="relative" [style.height.px]="topTermsChartHeight">
        <div *ngIf="isTopTermsLoading">
          <p-skeleton height="100%"></p-skeleton>
        </div>
        <div *ngIf="!isTopTermsLoading && topTermsData" class="h-full">
          <p-chart type="bar" [data]="topTermsData" [options]="topTermsOptions" width="100%" height="100%"></p-chart>
        </div>
      </div>
    </div>
  </div>

  <!-- Error Message -->
  <div *ngIf="error && !isLoading" class="mt-6 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md shadow-md" role="alert">
    <p class="font-bold">Error Loading Charts</p>
    <p>{{ error }}</p>
  </div>
</div>
